# name: E2E Tests

# on:
#   push:
#     branches:
#       - main
#       - develop
#   pull_request:
#     branches:
#       - main
#       - develop
#   workflow_dispatch:

# jobs:
#   e2e-tests:
#     name: Run E2E Tests
#     runs-on: ubuntu-latest
#     timeout-minutes: 30

#     services:
#       postgres:
#         image: postgres:15
#         env:
#           POSTGRES_USER: test_user
#           POSTGRES_PASSWORD: test_password
#           POSTGRES_DB: meal_planner_test
#         options: >-
#           --health-cmd pg_isready
#           --health-interval 10s
#           --health-timeout 5s
#           --health-retries 5
#         ports:
#           - 5432:5432

#       redis:
#         image: redis:7-alpine
#         options: >-
#           --health-cmd "redis-cli ping"
#           --health-interval 10s
#           --health-timeout 5s
#           --health-retries 5
#         ports:
#           - 6379:6379

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Setup Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: '20'

#       - name: Install pnpm
#         uses: pnpm/action-setup@v4
#         with:
#           version: 9.15.0
#           run_install: false

#       - name: Get pnpm store directory
#         id: pnpm-cache
#         shell: bash
#         run: |
#           echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

#       - name: Setup pnpm cache
#         uses: actions/cache@v4
#         with:
#           path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
#           key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
#           restore-keys: |
#             ${{ runner.os }}-pnpm-store-

#       - name: Install dependencies
#         run: pnpm install --frozen-lockfile

#       - name: Install Playwright browsers
#         run: pnpm exec playwright install --with-deps chromium

#       - name: Setup test environment variables
#         run: |
#           cat > .env.test << EOF
#           # Database
#           DATABASE_URL="postgresql://test_user:test_password@localhost:5432/meal_planner_test"

#           # Redis
#           REDIS_URL="redis://localhost:6379"

#           # NextAuth
#           NEXTAUTH_URL="http://localhost:3001"
#           NEXTAUTH_SECRET="test-secret-key-for-ci-testing-only"

#           # Claude API (using placeholder - tests should mock this)
#           ANTHROPIC_API_KEY="${{ secrets.ANTHROPIC_API_KEY || 'test-api-key' }}"

#           # Email (using test configuration)
#           EMAIL_HOST="smtp.example.com"
#           EMAIL_PORT="587"
#           EMAIL_USER="test@example.com"
#           EMAIL_PASSWORD="test-password"
#           EMAIL_FROM="test@example.com"

#           # Application
#           NODE_ENV="test"
#           PORT="3001"
#           EOF

#       - name: Generate Prisma client
#         run: pnpm db:generate

#       - name: Build packages
#         run: pnpm build

#       - name: Run database migrations
#         run: pnpm db:migrate:deploy
#         env:
#           DATABASE_URL: postgresql://test_user:test_password@localhost:5432/meal_planner_test

#       - name: Seed test database
#         run: pnpm db:seed
#         env:
#           DATABASE_URL: postgresql://test_user:test_password@localhost:5432/meal_planner_test

#       - name: Run E2E tests
#         run: pnpm test:e2e
#         env:
#           DATABASE_URL: postgresql://test_user:test_password@localhost:5432/meal_planner_test
#           REDIS_URL: redis://localhost:6379
#           NEXTAUTH_URL: http://localhost:3001
#           NEXTAUTH_SECRET: test-secret-key-for-ci-testing-only
#           CI: true

#       - name: Upload test results
#         if: always()
#         uses: actions/upload-artifact@v4
#         with:
#           name: test-results
#           path: test-results/
#           retention-days: 7

#       - name: Upload Playwright report
#         if: always()
#         uses: actions/upload-artifact@v4
#         with:
#           name: playwright-report
#           path: playwright-report/
#           retention-days: 7

#       - name: Upload failure screenshots
#         if: failure()
#         uses: actions/upload-artifact@v4
#         with:
#           name: failure-screenshots
#           path: test-results/**/*.png
#           retention-days: 7
#           if-no-files-found: ignore

#       - name: Upload failure videos
#         if: failure()
#         uses: actions/upload-artifact@v4
#         with:
#           name: failure-videos
#           path: test-results/**/*.webm
#           retention-days: 7
#           if-no-files-found: ignore

#       - name: Upload trace files
#         if: failure()
#         uses: actions/upload-artifact@v4
#         with:
#           name: trace-files
#           path: test-results/**/*.zip
#           retention-days: 7
#           if-no-files-found: ignore

#       - name: Comment PR with test results
#         if: github.event_name == 'pull_request' && always()
#         uses: actions/github-script@v7
#         with:
#           script: |
#             const fs = require('fs');
#             const resultsPath = 'test-results/results.json';

#             if (!fs.existsSync(resultsPath)) {
#               console.log('No test results found');
#               return;
#             }

#             const results = JSON.parse(fs.readFileSync(resultsPath, 'utf8'));
#             const { stats } = results;

#             const total = stats.expected + stats.unexpected + stats.skipped + stats.flaky;
#             const passed = stats.expected;
#             const failed = stats.unexpected;
#             const skipped = stats.skipped;
#             const flaky = stats.flaky;

#             const emoji = failed > 0 ? '❌' : '✅';
#             const status = failed > 0 ? 'Failed' : 'Passed';

#             const body = `## ${emoji} E2E Test Results: ${status}

#             - **Total Tests**: ${total}
#             - **Passed**: ${passed} ✅
#             - **Failed**: ${failed} ❌
#             - **Skipped**: ${skipped} ⏭️
#             - **Flaky**: ${flaky} ⚠️

#             ${failed > 0 ? '### Failed Tests\n\nCheck the workflow artifacts for screenshots, videos, and traces.' : ''}

#             [View full report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`;

#             github.rest.issues.createComment({
#               issue_number: context.issue.number,
#               owner: context.repo.owner,
#               repo: context.repo.repo,
#               body: body
#             });

#       - name: Cleanup test environment
#         if: always()
#         run: |
#           # Kill any remaining processes
#           pkill -f "next" || true
#           pkill -f "playwright" || true
#           # Clean up test artifacts if needed
#           echo "Test environment cleanup complete"
